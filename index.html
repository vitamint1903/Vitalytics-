<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vitalytics â€” Scottish Football Analytics by @_vitaminT__</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Barlow:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #0a0a0a;
    --bg2:      #111111;
    --surface:  #161616;
    --surface2: #1e1e1e;
    --border:   #242424;
    --border2:  #2e2e2e;
    --red:      #e8192c;
    --red-dark: #b01020;
    --red-dim:  rgba(232,25,44,0.1);
    --red-glow: rgba(232,25,44,0.25);
    --white:    #f5f5f5;
    --off:      #e0e0e0;
    --muted2:   #888888;
    --muted:    #555555;
    --text:     #f0f0f0;
  }

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
background: var(â€“bg);
color: var(â€“text);
font-family: â€˜Barlowâ€™, sans-serif;
min-height: 100vh;
overflow-x: hidden;
cursor: default;
}

/* Diagonal stripe texture */
body::before {
content: â€˜â€™;
position: fixed; inset: 0;
background-image: repeating-linear-gradient(
-45deg,
transparent,
transparent 40px,
rgba(255,255,255,0.012) 40px,
rgba(255,255,255,0.012) 41px
);
pointer-events: none; z-index: 0;
}

/* Red top bar accent */
body::after {
content: â€˜â€™;
position: fixed; top: 0; left: 0; right: 0; height: 3px;
background: linear-gradient(90deg, var(â€“red-dark), var(â€“red), #ff3347, var(â€“red));
z-index: 999;
}

.z1 { position: relative; z-index: 1; }

/* â”€â”€ HEADER â”€â”€ */
header {
position: sticky; top: 3px; z-index: 200;
background: rgba(10,10,10,0.96);
backdrop-filter: blur(20px);
border-bottom: 1px solid var(â€“border2);
}

.header-inner {
max-width: 1400px; margin: 0 auto; padding: 0 28px;
display: flex; align-items: center; gap: 0;
height: 62px;
}

/* Logo area */
.logo-block {
display: flex; align-items: center; gap: 0;
margin-right: 40px;
text-decoration: none;
flex-shrink: 0;
}

.logo-v {
background: var(â€“red);
width: 42px; height: 42px;
display: flex; align-items: center; justify-content: center;
font-family: â€˜Oswaldâ€™, sans-serif;
font-size: 22px; font-weight: 700;
color: white;
letter-spacing: -1px;
clip-path: polygon(0 0, 100% 0, 100% 75%, 50% 100%, 0 75%);
margin-right: 12px;
flex-shrink: 0;
}

.logo-text {
font-family: â€˜Oswaldâ€™, sans-serif;
font-size: 1.55rem; font-weight: 700;
letter-spacing: 3px; text-transform: uppercase;
color: var(â€“white);
}
.logo-text span {
color: var(â€“red);
}
.logo-by {
font-family: â€˜Barlowâ€™, sans-serif;
font-size: 10px; color: var(â€“muted); letter-spacing: 1px;
margin-top: 2px;
}

nav { display: flex; gap: 2px; flex: 1; }
.nav-btn {
padding: 8px 20px;
background: none; border: none;
color: var(â€“muted2);
font-family: â€˜Barlow Condensedâ€™, sans-serif;
font-size: 13px; font-weight: 600; letter-spacing: 1px;
text-transform: uppercase;
cursor: pointer; transition: all 0.15s;
position: relative;
}
.nav-btn::after {
content: â€˜â€™; position: absolute; bottom: -1px; left: 20px; right: 20px; height: 2px;
background: var(â€“red); transform: scaleX(0); transition: transform 0.2s;
}
.nav-btn:hover { color: var(â€“white); }
.nav-btn.active { color: var(â€“white); }
.nav-btn.active::after { transform: scaleX(1); }

.header-right {
display: flex; align-items: center; gap: 12px;
margin-left: auto;
}

.status-pill {
display: flex; align-items: center; gap: 7px;
padding: 5px 12px;
border: 1px solid var(â€“border2);
border-radius: 20px;
font-size: 11px; color: var(â€“muted2);
font-family: â€˜Barlow Condensedâ€™, sans-serif; letter-spacing: 0.5px;
white-space: nowrap;
}
.status-dot {
width: 6px; height: 6px; border-radius: 50%;
background: var(â€“muted);
flex-shrink: 0;
}
.status-dot.live { background: #22c55e; box-shadow: 0 0 6px #22c55e; animation: blink 2s infinite; }
.status-dot.loading { background: #f59e0b; animation: blink 0.8s infinite; }
.status-dot.error { background: var(â€“red); }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:0.3} }

/* â”€â”€ MAIN â”€â”€ */
main { max-width: 1400px; margin: 0 auto; padding: 36px 28px 80px; }

.page { display: none; animation: fadeIn 0.2s ease; }
.page.active { display: block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* â”€â”€ HERO â”€â”€ */
.hero {
padding: 52px 0 44px;
border-bottom: 1px solid var(â€“border);
margin-bottom: 40px;
position: relative; overflow: hidden;
}
.hero-bg-text {
position: absolute; right: -20px; top: 50%; transform: translateY(-50%);
font-family: â€˜Oswaldâ€™, sans-serif; font-size: 11rem; font-weight: 700;
color: rgba(232,25,44,0.04); letter-spacing: -4px;
pointer-events: none; user-select: none; white-space: nowrap; line-height: 1;
}
.hero-tag {
font-family: â€˜Barlow Condensedâ€™, sans-serif;
font-size: 11px; font-weight: 600; letter-spacing: 4px; text-transform: uppercase;
color: var(â€“red); margin-bottom: 14px;
display: flex; align-items: center; gap: 10px;
}
.hero-tag::before {
content: â€˜â€™; display: block; width: 28px; height: 2px; background: var(â€“red);
}
.hero h1 {
font-family: â€˜Oswaldâ€™, sans-serif;
font-size: clamp(3rem, 6.5vw, 5.8rem);
font-weight: 700; letter-spacing: 1px; line-height: 1.05;
margin-bottom: 16px; text-transform: uppercase;
}
.hero h1 em { color: var(â€“red); font-style: normal; }
.hero p { color: var(â€“muted2); font-size: 15px; max-width: 480px; line-height: 1.6; }

/* â”€â”€ CONTROLS â”€â”€ */
.controls-bar {
display: flex; gap: 12px; align-items: center;
flex-wrap: wrap; margin-bottom: 28px;
}

.search-wrap { position: relative; }
.search-wrap svg { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); color: var(â€“muted); pointer-events: none; }
input[type=text] {
padding: 11px 16px 11px 40px;
background: var(â€“surface);
border: 1px solid var(â€“border2);
border-radius: 6px; outline: none;
color: var(â€“text); font-family: â€˜Barlowâ€™, sans-serif; font-size: 14px;
width: 240px; transition: border-color 0.2s, box-shadow 0.2s;
}
input[type=text]:focus { border-color: var(â€“red); box-shadow: 0 0 0 3px var(â€“red-dim); }
input[type=text]::placeholder { color: var(â€“muted); }

select {
padding: 11px 14px;
background: var(â€“surface); border: 1px solid var(â€“border2); border-radius: 6px;
color: var(â€“text); font-family: â€˜Barlowâ€™, sans-serif; font-size: 14px;
cursor: pointer; outline: none; transition: border-color 0.2s;
}
select:focus { border-color: var(â€“red); }

.btn {
padding: 11px 24px; border-radius: 6px; border: none;
font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 13px; font-weight: 700;
letter-spacing: 1px; text-transform: uppercase;
cursor: pointer; transition: all 0.18s;
}
.btn-red {
background: var(â€“red); color: white;
}
.btn-red:hover { background: #ff2236; transform: translateY(-1px); box-shadow: 0 6px 20px var(â€“red-glow); }
.btn-red:disabled { background: var(â€“muted); cursor: not-allowed; transform: none; box-shadow: none; }
.btn-ghost {
background: none; border: 1px solid var(â€“border2); color: var(â€“muted2);
}
.btn-ghost:hover { border-color: var(â€“red); color: var(â€“red); }

/* League selector */
.league-selector-row {
display: flex; gap: 16px; margin-bottom: 28px; flex-wrap: wrap; align-items: flex-end;
}
.country-select-wrap, .league-select-wrap { display: flex; flex-direction: column; gap: 6px; }
.select-label {
font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 11px; font-weight: 700;
letter-spacing: 2px; text-transform: uppercase; color: var(â€“muted2);
}
.league-selector-row select { min-width: 220px; }

/* League tabs */
.league-tabs { display: flex; gap: 0; margin-bottom: 32px; border-bottom: 1px solid var(â€“border2); }
.league-tab {
padding: 12px 22px; background: none; border: none;
color: var(â€“muted); font-family: â€˜Barlow Condensedâ€™, sans-serif;
font-size: 13px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;
cursor: pointer; transition: all 0.15s;
border-bottom: 2px solid transparent; margin-bottom: -1px;
white-space: nowrap;
}
.league-tab:hover { color: var(â€“white); }
.league-tab.active { color: var(â€“white); border-bottom-color: var(â€“red); }

/* Position pills */
.pos-bar { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
.pos-pill {
padding: 5px 16px; border-radius: 2px;
border: 1px solid var(â€“border); background: none;
color: var(â€“muted); font-family: â€˜Barlow Condensedâ€™, sans-serif;
font-size: 12px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
cursor: pointer; transition: all 0.15s;
}
.pos-pill:hover { color: var(â€“white); border-color: var(â€“border2); }
.pos-pill.active { background: var(â€“red); color: white; border-color: var(â€“red); }

/* â”€â”€ PLAYER GRID â”€â”€ */
.player-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(285px, 1fr));
gap: 14px;
}

.player-card {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: 8px; padding: 20px;
cursor: pointer; transition: all 0.2s;
position: relative; overflow: hidden;
}
.player-card::before {
content: â€˜â€™; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
background: var(â€“red); transform: scaleY(0); transform-origin: bottom;
transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
}
.player-card:hover { border-color: var(â€“border2); transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
.player-card:hover::before { transform: scaleY(1); }
.player-card.compare-on { border-color: #888; }
.player-card.compare-on::before { background: white; transform: scaleY(1); }

.card-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
.card-left {}
.card-name {
font-family: â€˜Oswaldâ€™, sans-serif; font-size: 16px; font-weight: 600;
letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 7px;
line-height: 1.2;
}
.card-tags { display: flex; gap: 5px; flex-wrap: wrap; }
.tag {
padding: 2px 8px; border-radius: 2px;
font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 11px; font-weight: 700;
letter-spacing: 0.5px; text-transform: uppercase;
}
.tag-pos { background: var(â€“red-dim); color: var(â€“red); border: 1px solid rgba(232,25,44,0.25); }
.tag-club { background: var(â€“surface2); color: var(â€“muted2); border: 1px solid var(â€“border2); }
.tag-age { background: var(â€“surface2); color: var(â€“muted); border: 1px solid var(â€“border); }

.card-score-block { text-align: right; flex-shrink: 0; }
.card-score-num {
font-family: â€˜Oswaldâ€™, sans-serif; font-size: 2.8rem; font-weight: 700;
line-height: 1; color: var(â€“red);
}
.card-score-sub { font-size: 10px; color: var(â€“muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

.card-bars { display: flex; flex-direction: column; gap: 7px; margin-bottom: 14px; }
.bar-row { display: flex; align-items: center; gap: 8px; }
.bar-label { font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 11px; color: var(â€“muted); width: 90px; flex-shrink: 0; letter-spacing: 0.3px; }
.bar-track { flex: 1; height: 3px; background: var(â€“border2); border-radius: 1px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 1px; transition: width 0.9s cubic-bezier(0.4,0,0.2,1); }
.bar-val { font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 11px; color: var(â€“muted2); width: 22px; text-align: right; }

.card-actions { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(â€“border); }
.card-action {
flex: 1; padding: 7px 10px; text-align: center;
background: none; border: 1px solid var(â€“border2); border-radius: 4px;
color: var(â€“muted2); font-family: â€˜Barlow Condensedâ€™, sans-serif;
font-size: 12px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
cursor: pointer; transition: all 0.15s;
}
.card-action:hover { color: var(â€“red); border-color: var(â€“red); }
.card-action.compare-active { color: white; border-color: white; background: rgba(255,255,255,0.08); }

/* â”€â”€ DETAIL PAGE â”€â”€ */
.back-row {
display: flex; align-items: center; gap: 8px;
color: var(â€“muted2); font-size: 13px; cursor: pointer;
margin-bottom: 32px; width: fit-content; transition: color 0.15s;
font-family: â€˜Barlow Condensedâ€™, sans-serif; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;
}
.back-row:hover { color: var(â€“red); }

.detail-banner {
background: var(â€“surface); border: 1px solid var(â€“border);
border-radius: 8px; padding: 32px 36px; margin-bottom: 20px;
display: flex; align-items: center; gap: 32px; flex-wrap: wrap;
position: relative; overflow: hidden;
}
.detail-banner::after {
content: â€˜â€™; position: absolute; right: -30px; top: -30px;
width: 200px; height: 200px; border-radius: 50%;
background: radial-gradient(circle, var(â€“red-dim) 0%, transparent 70%);
pointer-events: none;
}

.detail-avatar {
width: 76px; height: 76px; border-radius: 50%;
background: linear-gradient(135deg, var(â€“red), var(â€“red-dark));
display: flex; align-items: center; justify-content: center;
font-family: â€˜Oswaldâ€™, sans-serif; font-size: 24px; font-weight: 700; color: white;
flex-shrink: 0; border: 2px solid rgba(232,25,44,0.4);
}
.detail-info { flex: 1; min-width: 180px; }
.detail-name {
font-family: â€˜Oswaldâ€™, sans-serif; font-size: 2.4rem; font-weight: 700;
letter-spacing: 1px; text-transform: uppercase; line-height: 1; margin-bottom: 10px;
}
.detail-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.detail-facts { display: flex; gap: 24px; flex-wrap: wrap; }
.detail-fact { font-size: 13px; color: var(â€“muted2); }
.detail-fact strong { color: var(â€“white); }

.detail-score-wrap { text-align: center; flex-shrink: 0; }
.detail-score {
font-family: â€˜Oswaldâ€™, sans-serif; font-size: 5rem; font-weight: 700; line-height: 1;
color: var(â€“red);
}
.detail-score-label { font-size: 11px; color: var(â€“muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }

.charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
@media(max-width:800px){ .charts-row{grid-template-columns:1fr} }

.card-panel {
background: var(â€“surface); border: 1px solid var(â€“border); border-radius: 8px; padding: 24px;
}
.panel-title {
font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 11px; font-weight: 700;
letter-spacing: 3px; text-transform: uppercase; color: var(â€“red); margin-bottom: 20px;
display: flex; align-items: center; gap: 8px;
}
.panel-title::before { content: â€˜//â€™; opacity: 0.4; }

.pct-key { display: flex; gap: 14px; flex-wrap: wrap; justify-content: center; margin-top: 14px; }
.pct-key-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(â€“muted); font-family: â€˜Barlow Condensedâ€™, sans-serif; }
.pct-dot { width: 8px; height: 8px; border-radius: 1px; }

.stats-boxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 10px; margin-top: 4px; }
.stat-box {
background: var(â€“surface2); border: 1px solid var(â€“border);
border-radius: 6px; padding: 14px 16px; text-align: center;
}
.stat-box-val { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.8rem; font-weight: 600; color: var(â€“white); }
.stat-box-lbl { font-size: 10px; color: var(â€“muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 3px; font-family: â€˜Barlow Condensedâ€™, sans-serif; }

/* â”€â”€ RANKINGS â”€â”€ */
.rank-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
.rank-title { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

.rank-table { width: 100%; border-collapse: collapse; }
.rank-table thead th {
text-align: left; padding: 11px 16px;
font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 11px; font-weight: 700;
letter-spacing: 2px; text-transform: uppercase; color: var(â€“muted);
border-bottom: 2px solid var(â€“border2);
}
.rank-table tbody tr { cursor: pointer; transition: background 0.12s; }
.rank-table tbody tr:hover td { background: var(â€“surface2); }
.rank-table tbody td { padding: 13px 16px; border-bottom: 1px solid var(â€“border); }

.rank-num { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.3rem; font-weight: 700; color: var(â€“muted); width: 44px; }
.rank-num.g1 { color: #fbbf24; }
.rank-num.g2 { color: #94a3b8; }
.rank-num.g3 { color: #b45309; }
.rank-pname { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
.rank-bar-row { display: flex; align-items: center; gap: 10px; }
.rank-bar-bg { width: 100px; height: 4px; background: var(â€“border2); border-radius: 2px; overflow: hidden; }
.rank-bar-inner { height: 100%; background: linear-gradient(90deg, var(â€“red), #ff6b6b); border-radius: 2px; }
.rank-val { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 14px; font-weight: 600; color: var(â€“red); width: 30px; }

/* â”€â”€ COMPARE â”€â”€ */
.compare-empty {
text-align: center; padding: 80px 20px;
font-size: 14px; color: var(â€“muted);
}
.compare-empty h3 { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.8rem; color: var(â€“muted2); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

.compare-banner {
display: grid; grid-template-columns: 1fr 70px 1fr;
background: var(â€“surface); border: 1px solid var(â€“border);
border-radius: 8px; overflow: hidden; margin-bottom: 20px;
}
.compare-col { padding: 28px 24px; }
.compare-col:first-child { border-right: 1px solid var(â€“border); }
.compare-mid { background: var(â€“surface2); display: flex; align-items: center; justify-content: center; }
.vs-txt { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.6rem; font-weight: 700; color: var(â€“border2); }
.compare-name { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.compare-sub { color: var(â€“muted2); font-size: 13px; margin-bottom: 10px; }
.compare-big { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 3.5rem; font-weight: 700; color: var(â€“red); line-height: 1; }

.compare-table { width: 100%; border-collapse: collapse; }
.compare-table td { padding: 11px 16px; border-bottom: 1px solid var(â€“border); }
.c-name-cell { text-align: center; font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 12px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(â€“muted); }
.c-val { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 15px; font-weight: 600; }
.c-val.win { color: var(â€“red); }
.c-val.lose { color: var(â€“muted); }
.c-val.left { text-align: right; }
.c-val.right { text-align: left; }

/* â”€â”€ LOADING / STATES â”€â”€ */
.loading-wrap { text-align: center; padding: 80px 20px; }
.spinner {
width: 36px; height: 36px; margin: 0 auto 16px;
border: 3px solid var(â€“border2);
border-top-color: var(â€“red);
border-radius: 50%; animation: spin 0.7s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }
.loading-main { color: var(â€“muted2); font-size: 15px; font-family: â€˜Barlow Condensedâ€™, sans-serif; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
.loading-sub { color: var(â€“muted); font-size: 12px; margin-top: 6px; }

.notice {
background: var(â€“surface); border: 1px solid var(â€“border2);
border-left: 3px solid var(â€“red);
border-radius: 4px; padding: 13px 18px;
font-size: 13px; color: var(â€“muted2); margin-bottom: 28px; line-height: 1.5;
}
.notice strong { color: var(â€“white); }

.error-notice {
background: rgba(232,25,44,0.08); border: 1px solid rgba(232,25,44,0.3);
border-radius: 6px; padding: 14px 18px;
color: #fca5a5; font-size: 13px; margin: 16px 0;
}

.empty-state { text-align: center; padding: 60px 20px; color: var(â€“muted); font-size: 14px; }
.empty-state h3 { font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.4rem; color: var(â€“muted2); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }

/* â”€â”€ COMPARE FLOAT BAR â”€â”€ */
.float-bar {
position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%);
background: var(â€“surface2); border: 1px solid var(â€“border2);
border-top: 2px solid var(â€“red);
border-radius: 8px; padding: 14px 22px;
display: flex; align-items: center; gap: 16px;
box-shadow: 0 12px 40px rgba(0,0,0,0.5);
z-index: 300; white-space: nowrap;
animation: popUp 0.25s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes popUp { from{opacity:0;transform:translateX(-50%) translateY(20px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
.float-bar-text { font-family: â€˜Barlow Condensedâ€™, sans-serif; font-size: 13px; color: var(â€“muted2); letter-spacing: 0.5px; }
.float-bar-names { color: var(â€“white); font-weight: 600; }

/* chart canvas */
canvas { display: block; }

/* â”€â”€ SHARE MODAL â”€â”€ */
.modal-backdrop {
position: fixed; inset: 0; z-index: 500;
background: rgba(0,0,0,0.85);
backdrop-filter: blur(8px);
display: flex; align-items: center; justify-content: center;
padding: 20px;
animation: fadeIn 0.2s ease;
}
.modal {
background: var(â€“surface);
border: 1px solid var(â€“border2);
border-top: 3px solid var(â€“red);
border-radius: 10px;
padding: 28px;
width: 100%; max-width: 560px;
animation: slideUp 0.25s cubic-bezier(0.34,1.2,0.64,1);
}
@keyframes slideUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
.modal-header {
display: flex; align-items: center; justify-content: space-between;
margin-bottom: 20px;
}
.modal-title {
font-family: â€˜Oswaldâ€™, sans-serif; font-size: 1.2rem; font-weight: 700;
text-transform: uppercase; letter-spacing: 1px;
}
.modal-close {
width: 32px; height: 32px; border-radius: 6px;
background: var(â€“surface2); border: 1px solid var(â€“border2);
color: var(â€“muted2); font-size: 16px; cursor: pointer;
display: flex; align-items: center; justify-content: center;
transition: all 0.15s;
}
.modal-close:hover { color: var(â€“red); border-color: var(â€“red); }

.share-preview {
border: 1px solid var(â€“border2); border-radius: 8px;
overflow: hidden; margin-bottom: 20px;
display: flex; justify-content: center;
background: #000;
}
.share-preview canvas { max-width: 100%; height: auto; }

.share-actions { display: flex; gap: 10px; }
.btn-x {
display: flex; align-items: center; gap: 8px;
padding: 11px 20px; border-radius: 6px; border: none;
background: #000; color: white;
font-family: â€˜Barlow Condensedâ€™, sans-serif;
font-size: 13px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
cursor: pointer; transition: all 0.18s; text-decoration: none;
border: 1px solid #333;
}
.btn-x:hover { background: #111; border-color: #555; transform: translateY(-1px); }
.btn-download {
display: flex; align-items: center; gap: 8px;
padding: 11px 20px; border-radius: 6px; border: none;
background: var(â€“surface2); border: 1px solid var(â€“border2);
color: var(â€“muted2);
font-family: â€˜Barlow Condensedâ€™, sans-serif;
font-size: 13px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
cursor: pointer; transition: all 0.18s;
}
.btn-download:hover { color: var(â€“white); border-color: var(â€“border2); }

.share-hint {
margin-top: 14px; font-size: 12px; color: var(â€“muted);
line-height: 1.5; font-family: â€˜Barlowâ€™, sans-serif;
}
.share-hint strong { color: var(â€“muted2); }
</style>

</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo-block">
      <div class="logo-v">V</div>
      <div>
        <div class="logo-text">Vital<span>ytics</span></div>
        <div class="logo-by">by @_vitaminT__ on X</div>
      </div>
    </div>
    <nav>
      <button class="nav-btn active" onclick="showPage('search')">Search</button>
      <button class="nav-btn" onclick="showPage('rankings')">Rankings</button>
      <button class="nav-btn" onclick="showPage('compare')">Compare</button>
    </nav>
    <div class="header-right">
      <div class="status-pill">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Ready</span>
      </div>
    </div>
  </div>
</header>

<main class="z1">

  <!-- â•â• SEARCH â•â• -->

  <div class="page active" id="page-search">
    <div class="hero">
      <div class="hero-bg-text">VITALYTICS</div>
      <div class="hero-tag">European Football Analytics</div>
      <h1>Every Player.<br><em>Every Stat.</em><br>Ranked.</h1>
      <p>Scottish &amp; European football. Live data from SofaScore â€” ranked by position within each league.</p>
    </div>

```
<div class="notice">
  <strong>How to use:</strong> Pick a country, then a league, then hit <strong>Load Players</strong>. Takes ~2 mins per league. Percentile colours: <span style="color:#FFD700;font-weight:700">â— Gold</span> = top 10% &nbsp;<span style="color:#22c55e;font-weight:700">â— Green</span> = above avg &nbsp;<span style="color:#ca8a04;font-weight:700">â— Yellow</span> = average &nbsp;<span style="color:#e8192c;font-weight:700">â— Red</span> = below avg
</div>

<!-- Country + League selectors -->
<div class="league-selector-row">
  <div class="country-select-wrap">
    <label class="select-label">Country</label>
    <select id="countrySelect" onchange="onCountryChange()">
      <option value="">â€” Select Country â€”</option>
    </select>
  </div>
  <div class="league-select-wrap">
    <label class="select-label">League</label>
    <select id="leagueSelect" onchange="onLeagueChange()" disabled>
      <option value="">â€” Select League â€”</option>
    </select>
  </div>
</div>

<div class="controls-bar">
  <div class="search-wrap">
    <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="searchInput" placeholder="Search playerâ€¦" oninput="filterCards()">
  </div>
  <button class="btn btn-red" id="loadBtn" onclick="runLoad()">Load Players</button>
</div>

<div class="pos-bar" id="posBar" style="display:none">
  <button class="pos-pill active" data-p="ALL" onclick="pickPos(this)">All</button>
  <button class="pos-pill" data-p="GK" onclick="pickPos(this)">GK</button>
  <button class="pos-pill" data-p="D" onclick="pickPos(this)">DEF</button>
  <button class="pos-pill" data-p="M" onclick="pickPos(this)">MID</button>
  <button class="pos-pill" data-p="F" onclick="pickPos(this)">FWD</button>
</div>

<div id="gridArea"></div>
```

  </div>

  <!-- â•â• RANKINGS â•â• -->

  <div class="page" id="page-rankings">
    <div class="rank-controls">
      <div class="rank-title">Player Rankings</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <select id="rkLeague" onchange="buildRankings()">
          <option value="">â€” Load a league first â€”</option>
        </select>
        <select id="rkPos" onchange="buildRankings()">
          <option value="ALL">All Positions</option>
          <option value="GK">Goalkeepers</option>
          <option value="D">Defenders</option>
          <option value="M">Midfielders</option>
          <option value="F">Forwards</option>
        </select>
      </div>
    </div>
    <div id="rankArea">
      <div class="empty-state"><h3>No data loaded</h3><p>Go to Search and load a league first</p></div>
    </div>
  </div>

  <!-- â•â• COMPARE â•â• -->

  <div class="page" id="page-compare">
    <div class="rank-title" style="margin-bottom:24px">Head to Head</div>
    <div id="compareArea">
      <div class="compare-empty">
        <h3>No Players Selected</h3>
        <p>Hit the <strong>Compare</strong> button on two player cards, then click <strong>Compare Now</strong> at the bottom of the screen.</p>
      </div>
    </div>
  </div>

  <!-- â•â• DETAIL â•â• -->

  <div class="page" id="page-detail">
    <div class="back-row" onclick="goBack()">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 12H5m7-7-7 7 7 7"/></svg>
      Back
    </div>
    <div id="detailArea"></div>
  </div>

</main>

<!-- SHARE MODAL -->

<div class="modal-backdrop" id="shareModal" style="display:none" onclick="closeShareModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¤ Share to X</div>
      <button class="modal-close" onclick="closeShareModal()">âœ•</button>
    </div>
    <div class="share-preview">
      <canvas id="shareCanvas" width="600" height="600"></canvas>
    </div>
    <div class="share-actions">
      <a id="xShareBtn" href="#" target="_blank" class="btn-x" style="flex:1;justify-content:center">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.737-8.856L1.561 2.25H8.37l4.261 5.636L18.244 2.25zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        Post to X
      </a>
      <button class="btn-download" id="dlBtn" onclick="downloadShare()">
        <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Save Image
      </button>
    </div>
    <div class="share-hint">
      <strong>Tip:</strong> Click <strong>Save Image</strong> first, then <strong>Post to X</strong> â€” attach the saved image to the tweet for best results. The tweet text is pre-filled with the player's stats.
    </div>
  </div>
</div>

<!-- FLOAT COMPARE BAR -->

<div class="float-bar" id="floatBar" style="display:none">
  <div class="float-bar-text">Selected: <span class="float-bar-names" id="floatNames">â€”</span></div>
  <button class="btn btn-red" style="padding:8px 18px;font-size:12px" onclick="goCompare()">Compare Now â†’</button>
  <button class="btn btn-ghost" style="padding:8px 14px;font-size:12px" onclick="clearCmp()">âœ•</button>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EUROPEAN LEAGUES DATABASE
   SofaScore tournament IDs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LEAGUES_BY_COUNTRY = {
  'ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ Scotland': [
    { id: 17,  name: 'Premiership' },
    { id: 36,  name: 'Championship' },
    { id: 38,  name: 'League One' },
    { id: 39,  name: 'League Two' },
  ],
  'ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ England': [
    { id: 17335, name: 'Premier League' },
    { id: 18,    name: 'Championship' },
    { id: 19,    name: 'League One' },
  ],
  'ğŸ‡©ğŸ‡ª Germany': [
    { id: 35,  name: 'Bundesliga' },
    { id: 36,  name: '2. Bundesliga' },
    { id: 37,  name: '3. Liga' },
  ],
  'ğŸ‡ªğŸ‡¸ Spain': [
    { id: 8,   name: 'La Liga' },
    { id: 54,  name: 'La Liga 2' },
    { id: 132, name: 'Primera RFEF' },
  ],
  'ğŸ‡®ğŸ‡¹ Italy': [
    { id: 23,  name: 'Serie A' },
    { id: 53,  name: 'Serie B' },
    { id: 155, name: 'Serie C' },
  ],
  'ğŸ‡«ğŸ‡· France': [
    { id: 34,  name: 'Ligue 1' },
    { id: 182, name: 'Ligue 2' },
    { id: 183, name: 'National' },
  ],
  'ğŸ‡³ğŸ‡± Netherlands': [
    { id: 37,  name: 'Eredivisie' },
    { id: 406, name: 'Eerste Divisie' },
    { id: 437, name: 'Tweede Divisie' },
  ],
  'ğŸ‡µğŸ‡¹ Portugal': [
    { id: 238, name: 'Primeira Liga' },
    { id: 239, name: 'Segunda Liga' },
    { id: 240, name: 'Liga 3' },
  ],
  'ğŸ‡§ğŸ‡ª Belgium': [
    { id: 68,  name: 'First Division A' },
    { id: 69,  name: 'First Division B' },
    { id: 70,  name: 'Second Amateur' },
  ],
  'ğŸ‡¹ğŸ‡· Turkey': [
    { id: 52,  name: 'SÃ¼per Lig' },
    { id: 98,  name: 'TFF 1. Lig' },
    { id: 99,  name: 'TFF 2. Lig' },
  ],
  'ğŸ‡³ğŸ‡´ Norway': [
    { id: 218, name: 'Eliteserien' },
    { id: 219, name: '1. divisjon' },
    { id: 220, name: '2. divisjon' },
  ],
  'ğŸ‡¸ğŸ‡ª Sweden': [
    { id: 231, name: 'Allsvenskan' },
    { id: 232, name: 'Superettan' },
    { id: 233, name: 'Division 1' },
  ],
  'ğŸ‡©ğŸ‡° Denmark': [
    { id: 200, name: 'Superliga' },
    { id: 201, name: '1. Division' },
    { id: 202, name: '2. Division' },
  ],
  'ğŸ‡¦ğŸ‡¹ Austria': [
    { id: 45,  name: 'Bundesliga' },
    { id: 46,  name: '2. Liga' },
    { id: 47,  name: 'Regionalliga' },
  ],
  'ğŸ‡¨ğŸ‡­ Switzerland': [
    { id: 215, name: 'Super League' },
    { id: 216, name: 'Challenge League' },
    { id: 217, name: 'Promotion League' },
  ],
  'ğŸ‡¬ğŸ‡· Greece': [
    { id: 163, name: 'Super League' },
    { id: 164, name: 'Super League 2' },
    { id: 165, name: 'Gamma Ethniki' },
  ],
  'ğŸ‡·ğŸ‡´ Romania': [
    { id: 172, name: 'Liga I' },
    { id: 173, name: 'Liga II' },
    { id: 174, name: 'Liga III' },
  ],
  'ğŸ‡¨ğŸ‡¿ Czech Republic': [
    { id: 100, name: 'Fortuna Liga' },
    { id: 101, name: 'Fortuna:NÃ¡rodnÃ­ liga' },
    { id: 102, name: 'Divize' },
  ],
  'ğŸ‡µğŸ‡± Poland': [
    { id: 171, name: 'Ekstraklasa' },
    { id: 176, name: 'I liga' },
    { id: 177, name: 'II liga' },
  ],
  'ğŸ‡·ğŸ‡¸ Serbia': [
    { id: 203, name: 'SuperLiga' },
    { id: 204, name: 'Liga Serbia' },
    { id: 205, name: 'Liga Serbia 3' },
  ],
  'ğŸ‡­ğŸ‡· Croatia': [
    { id: 175, name: 'HNL' },
    { id: 436, name: '1. NL' },
    { id: 438, name: '2. NL' },
  ],
  'ğŸ‡ºğŸ‡¦ Ukraine': [
    { id: 182, name: 'Premier League' },
    { id: 435, name: 'PershĞ° liha' },
    { id: 439, name: 'Druha liha' },
  ],
  'ğŸ‡·ğŸ‡º Russia': [
    { id: 203, name: 'Premier League' },
    { id: 206, name: 'FNL' },
    { id: 207, name: 'PFL' },
  ],
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const S = {
  league: 17,
  leagueName: 'Premiership',
  countryName: 'ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ Scotland',
  byLeague: {},
  allPlayers: [],
  filterPos: 'ALL',
  filterName: '',
  cmpQueue: [],
  prevPage: 'search',
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COUNTRY / LEAGUE PICKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initPicker() {
  const csel = document.getElementById('countrySelect');
  Object.keys(LEAGUES_BY_COUNTRY).forEach(country => {
    const opt = document.createElement('option');
    opt.value = country;
    opt.textContent = country;
    csel.appendChild(opt);
  });
  // Default to Scotland
  csel.value = 'ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ Scotland';
  onCountryChange();
}

function onCountryChange() {
  const country = document.getElementById('countrySelect').value;
  const lsel = document.getElementById('leagueSelect');
  lsel.innerHTML = '<option value="">â€” Select League â€”</option>';
  if (!country) { lsel.disabled = true; return; }
  const leagues = LEAGUES_BY_COUNTRY[country] || [];
  leagues.forEach(l => {
    const opt = document.createElement('option');
    opt.value = l.id;
    opt.textContent = l.name;
    lsel.appendChild(opt);
  });
  lsel.disabled = false;
  // Auto-select first
  if (leagues.length) {
    lsel.value = leagues[0].id;
    onLeagueChange();
  }
  S.countryName = country;
}

function onLeagueChange() {
  const lsel = document.getElementById('leagueSelect');
  const id = parseInt(lsel.value);
  if (!id) return;
  const country = document.getElementById('countrySelect').value;
  const leagues = LEAGUES_BY_COUNTRY[country] || [];
  const league = leagues.find(l => l.id === id);
  S.league = id;
  S.leagueName = league ? league.name : '';
  // Show cached data if available
  if (S.byLeague[id]) {
    document.getElementById('posBar').style.display = 'flex';
    renderGrid();
  } else {
    document.getElementById('gridArea').innerHTML = '';
    document.getElementById('posBar').style.display = 'none';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach((b,i) => b.classList.toggle('active', ['search','rankings','compare'][i]===name));
  if (name === 'rankings') buildRankings();
}
function goBack() { showPage(S.prevPage); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setStatus(cls, txt) {
  document.getElementById('statusDot').className = 'status-dot ' + cls;
  document.getElementById('statusText').textContent = txt;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SS = 'https://api.sofascore.com/api/v1';
const sleep = ms => new Promise(r => setTimeout(r, ms));

// SofaScore requires browser-like headers â€” we send these through each proxy
const SS_HEADERS = {
  'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
  'Accept': 'application/json',
  'Accept-Language': 'en-GB,en;q=0.9',
  'Referer': 'https://www.sofascore.com/',
  'Origin': 'https://www.sofascore.com',
};

const PROXIES = [
  // corsproxy.io â€” most reliable, passes custom headers
  url => ({ url: `https://corsproxy.io/?${encodeURIComponent(url)}`, headers: SS_HEADERS }),
  // allorigins â€” wraps response in JSON {contents:"..."}
  url => ({ url: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, headers: {} }),
  // cors.sh â€” requires no extra headers
  url => ({ url: `https://cors.sh/${url}`, headers: { 'x-cors-api-key': 'temp_' + Math.random().toString(36).slice(2) } }),
  // corsproxy.org
  url => ({ url: `https://corsproxy.org/?${encodeURIComponent(url)}`, headers: {} }),
];

async function api(path) {
  const target = SS + path;
  let lastErr = null;

  for (const makeProxy of PROXIES) {
    try {
      const { url, headers } = makeProxy(target);
      const r = await fetch(url, {
        headers,
        signal: AbortSignal.timeout(14000),
      });
      if (r.status === 403) throw new Error('HTTP 403 â€” blocked');
      if (r.status === 404) throw new Error('HTTP 404');
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const text = await r.text();
      try {
        const j = JSON.parse(text);
        // allorigins wraps as { contents: "..." }
        if (j && typeof j.contents === 'string') return JSON.parse(j.contents);
        return j;
      } catch {
        throw new Error('Bad JSON');
      }
    } catch (e) {
      lastErr = e;
      console.warn(`Proxy failed:`, e.message);
      await sleep(600);
    }
  }
  throw new Error(`All proxies failed. Last error: ${lastErr?.message}`);
}

async function getSeason(tid) {
  const d = await api(`/unique-tournament/${tid}/seasons`);
  if (!d.seasons?.length) throw new Error('No seasons found');
  return d.seasons[0].id;
}

async function getTeams(tid, sid) {
  const d = await api(`/unique-tournament/${tid}/season/${sid}/teams`);
  return d.teams || [];
}

async function getSquad(teamId) {
  const d = await api(`/team/${teamId}/players`);
  return (d.players || []).map(e => e.player || e);
}

async function getStats(pid, tid, sid) {
  try {
    const d = await api(`/player/${pid}/unique-tournament/${tid}/season/${sid}/statistics/overall`);
    return d.statistics || null;
  } catch { return null; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD PIPELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runLoad() {
  const btn = document.getElementById('loadBtn');
  btn.disabled = true; btn.textContent = 'Loadingâ€¦';
  setStatus('loading', 'Connectingâ€¦');
  showLoading('gridArea', 'Connecting to SofaScoreâ€¦', 'Fetching current season');

  try {
    const tid = S.league;
    const sid = await getSeason(tid);
    const teams = await getTeams(tid, sid);
    setStatus('loading', `0 / ${teams.length} teams`);

    const players = []; const seen = new Set();

    for (let i = 0; i < teams.length; i++) {
      const team = teams[i];
      setStatus('loading', `${i+1} / ${teams.length} â€” ${team.name}`);
      showLoading('gridArea', `Loading ${team.name}`, `Team ${i+1} of ${teams.length} Â· fetching squad & statsâ€¦`);

      try {
        const squad = await getSquad(team.id);
        await sleep(350);
        for (const p of squad) {
          if (seen.has(p.id)) continue; seen.add(p.id);
          const stats = await getStats(p.id, tid, sid);
          await sleep(220);
          if (!stats || (stats.appearances||0) < 3) continue;
          players.push(buildPlayer(p, team, stats, tid, sid));
        }
      } catch(e) { console.warn(team.name, e); }
    }

    calcPercentiles(players);
    S.byLeague[tid] = players;
    S.allPlayers = Object.values(S.byLeague).flat();

    setStatus('live', `${players.length} players`);
    document.getElementById('posBar').style.display = 'flex';
    populateRankLeagueSelect();
    renderGrid();

  } catch(e) {
    setStatus('error', 'Failed');
    document.getElementById('gridArea').innerHTML = `
      <div class="error-notice">
        <strong>âš ï¸ Could not reach SofaScore</strong><br><br>
        ${e.message}<br><br>
        <strong>Things to try:</strong><br>
        1. Make sure you're using <strong>Chrome or Firefox</strong> (Safari blocks cross-site requests)<br>
        2. Try disabling any <strong>ad blocker or privacy extension</strong> â€” they often block CORS proxies<br>
        3. If hosted on a website, this should work fine â€” the issue only affects local file access in some browsers<br>
        4. Wait 60 seconds and click Reload
      </div>`;
  }

  btn.disabled = false; btn.textContent = 'Reload';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD PLAYER OBJECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPlayer(p, team, s, tid, sid) {
  const apps = s.appearances || 1;
  const pg = k => +(((s[k]||0)/apps).toFixed(2));
  const pct = k => +(s[k]||0).toFixed(1);
  return {
    id: p.id, name: p.name,
    shortName: p.shortName || p.name.split(' ').pop(),
    pos: p.position || 'M',
    posDetail: p.positionName || '',
    teamId: team.id, teamName: team.name,
    teamShort: team.shortName || team.name.split(' ')[0],
    nat: (p.nationality||{}).alpha2 || '',
    age: p.age || 0, height: p.height || null,
    tid, sid,
    raw: {
      apps, mins: s.minutesPlayed||0,
      goals: pg('goals'), assists: pg('assists'),
      shots: pg('totalShots'), shotsOT: pg('shotsOnTarget'),
      keyPasses: pg('keyPasses'), passAcc: pct('accuratePassesPercentage'),
      dribbles: pg('successfulDribbles'),
      tackles: pg('tackles'), interceptions: pg('interceptions'),
      clearances: pg('clearances'),
      aerialWon: pct('aerialDuelsWon'), duelsWon: pct('duelsWon'),
      saves: pg('saves'), savePct: pct('savePercentage'),
      cleanSheets: s.cleanSheet||0,
      xg: pg('expectedGoals'), xa: pg('expectedAssists'),
      bigChances: pg('bigChancesCreated'),
      yellowCards: s.yellowCards||0, redCards: s.redCards||0,
    },
    pcts: {}, score: 0,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERCENTILE ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DEFS = {
  GK: [
    {l:'Save %',     f:p=>p.raw.savePct,        lo:false},
    {l:'Saves/Game', f:p=>p.raw.saves,           lo:false},
    {l:'Clean Sheets',f:p=>p.raw.cleanSheets,    lo:false},
    {l:'Aerial Won %',f:p=>p.raw.aerialWon,      lo:false},
    {l:'Pass Acc %', f:p=>p.raw.passAcc,         lo:false},
    {l:'Conceded',   f:p=>p.raw.goals,           lo:true },
  ],
  D: [
    {l:'Aerial Won %',f:p=>p.raw.aerialWon,      lo:false},
    {l:'Tackles/Game',f:p=>p.raw.tackles,        lo:false},
    {l:'Interceptions',f:p=>p.raw.interceptions, lo:false},
    {l:'Clearances', f:p=>p.raw.clearances,      lo:false},
    {l:'Duels Won %',f:p=>p.raw.duelsWon,        lo:false},
    {l:'Pass Acc %', f:p=>p.raw.passAcc,         lo:false},
  ],
  M: [
    {l:'Key Passes', f:p=>p.raw.keyPasses,       lo:false},
    {l:'Pass Acc %', f:p=>p.raw.passAcc,         lo:false},
    {l:'Tackles/Game',f:p=>p.raw.tackles,        lo:false},
    {l:'Interceptions',f:p=>p.raw.interceptions, lo:false},
    {l:'Dribbles',   f:p=>p.raw.dribbles,        lo:false},
    {l:'xA/Game',    f:p=>p.raw.xa,              lo:false},
  ],
  F: [
    {l:'Goals/Game', f:p=>p.raw.goals,           lo:false},
    {l:'xG/Game',    f:p=>p.raw.xg,              lo:false},
    {l:'Shots/Game', f:p=>p.raw.shots,           lo:false},
    {l:'Key Passes', f:p=>p.raw.keyPasses,       lo:false},
    {l:'Dribbles',   f:p=>p.raw.dribbles,        lo:false},
    {l:'Assists/Game',f:p=>p.raw.assists,        lo:false},
  ],
};
const WTS = {
  GK:[.30,.25,.15,.10,.10,.10], D:[.20,.20,.18,.15,.15,.12],
  M:[.25,.20,.15,.15,.15,.10], F:[.30,.25,.15,.10,.10,.10],
};

function pctRank(val, pop, lowerBetter) {
  if (pop.length < 2) return 50;
  const s = [...pop].sort((a,b)=>a-b);
  const below = s.filter(v=>v<val).length;
  const equal = s.filter(v=>v===val).length;
  let r = ((below + 0.5*equal)/s.length)*100;
  if (lowerBetter) r = 100-r;
  return Math.max(0,Math.min(100,Math.round(r)));
}

function calcPercentiles(players) {
  const grps = {GK:[],D:[],M:[],F:[]};
  players.forEach(p => (grps[p.pos]||grps['M']).push(p));
  for (const [pos, grp] of Object.entries(grps)) {
    if (!grp.length) continue;
    const defs = DEFS[pos], wts = WTS[pos];
    const pops = defs.map(d => grp.map(p => d.f(p)));
    grp.forEach(p => {
      let sc = 0;
      defs.forEach((d,i) => {
        const v = d.f(p);
        const pv = pctRank(v, pops[i], d.lo);
        p.pcts[d.l] = pv;
        sc += pv * wts[i];
      });
      p.score = Math.round(sc);
    });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLORS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// 4-tier colour system:
// Gold  = top 10%  (90+)
// Green = above avg (60â€“89)
// Yellow = average  (40â€“59)
// Red   = below avg (0â€“39)
function pColor(v) {
  if (v >= 90) return '#FFD700'; // Gold
  if (v >= 60) return '#22c55e'; // Green
  if (v >= 40) return '#ca8a04'; // Amber/Yellow (distinct from gold)
  return '#e8192c';              // Red
}
function pColorLabel(v) {
  if (v >= 90) return 'gold';
  if (v >= 60) return 'green';
  if (v >= 40) return 'yellow';
  return 'red';
}
function sColor(v) {
  if (v >= 75) return '#FFD700';
  if (v >= 55) return '#22c55e';
  if (v >= 40) return '#ca8a04';
  return '#888888';
}
function posLabel(p) { return {GK:'GK',D:'DEF',M:'MID',F:'FWD'}[p]||p; }
function initials(n) { return n.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function pickPos(btn) {
  document.querySelectorAll('.pos-pill').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  S.filterPos = btn.dataset.p;
  renderGrid();
}
function filterCards() {
  S.filterName = document.getElementById('searchInput').value.toLowerCase();
  renderGrid();
}
function visible() {
  return (S.byLeague[S.league]||[]).filter(p =>
    (S.filterPos==='ALL' || p.pos===S.filterPos) &&
    (!S.filterName || p.name.toLowerCase().includes(S.filterName))
  ).sort((a,b)=>b.score-a.score);
}

function renderGrid() {
  const el = document.getElementById('gridArea');
  const ps = visible();
  if (!ps.length) { el.innerHTML = '<div class="empty-state"><h3>No players found</h3><p>Try a different filter</p></div>'; return; }
  el.innerHTML = `
    <div style="font-size:12px;color:var(--muted);font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;text-transform:uppercase;margin-bottom:14px">${ps.length} players â€” sorted by score</div>
    <div class="player-grid">${ps.map(cardHTML).join('')}</div>
  `;
}

function cardHTML(p) {
  const top4 = Object.entries(p.pcts).slice(0,4);
  const inCmp = S.cmpQueue.includes(p.id);
  return `
    <div class="player-card ${inCmp?'compare-on':''}" id="pc-${p.id}">
      <div class="card-top">
        <div class="card-left">
          <div class="card-name">${p.name}</div>
          <div class="card-tags">
            <span class="tag tag-pos">${posLabel(p.pos)}</span>
            <span class="tag tag-club">${p.teamShort}</span>
            ${p.age?`<span class="tag tag-age">${p.age}y</span>`:''}
          </div>
        </div>
        <div class="card-score-block">
          <div class="card-score-num" style="color:${sColor(p.score)}">${p.score}</div>
          <div class="card-score-sub">Score</div>
        </div>
      </div>
      <div class="card-bars">
        ${top4.map(([l,v])=>`
          <div class="bar-row">
            <div class="bar-label">${l}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${v}%;background:${pColor(v)}"></div></div>
            <div class="bar-val">${v}</div>
          </div>
        `).join('')}
      </div>
      <div class="card-actions">
        <div class="card-action" onclick="openDetail(${p.id})">Full Profile</div>
        <div class="card-action ${inCmp?'compare-active':''}" onclick="toggleCmp(${p.id},event)">${inCmp?'âœ“ Added':'+ Compare'}</div>
      </div>
    </div>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function findP(id) { return S.allPlayers.find(p=>p.id===id); }

function openDetail(id) {
  const p = findP(id); if (!p) return;
  S.prevPage = 'search';
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  document.getElementById('page-detail').classList.add('active');
  renderDetail(p);
}

function renderDetail(p) {
  const statBoxes = [
    ['Goals/Game',p.raw.goals],['Assists/Game',p.raw.assists],
    ['Shots/Game',p.raw.shots],['Key Passes',p.raw.keyPasses],
    ['Pass Acc %',p.raw.passAcc+'%'],['Tackles/Game',p.raw.tackles],
    ['Interceptions',p.raw.interceptions],['Aerial Won %',p.raw.aerialWon+'%'],
    ['Dribbles/Game',p.raw.dribbles],['xG/Game',p.raw.xg],['xA/Game',p.raw.xa],
    ['Appearances',p.raw.apps],
  ].filter(([,v])=>v!==0&&v!=='0%');

  document.getElementById('detailArea').innerHTML = `
    <div class="detail-banner">
      <div class="detail-avatar">${initials(p.name)}</div>
      <div class="detail-info">
        <div class="detail-name">${p.name}</div>
        <div class="detail-tags">
          <span class="tag tag-pos">${posLabel(p.pos)}</span>
          <span class="tag tag-club">${p.teamName}</span>
          ${p.age?`<span class="tag tag-age">Age ${p.age}</span>`:''}
          ${p.height?`<span class="tag tag-age">${p.height}cm</span>`:''}
        </div>
        <div class="detail-facts">
          <div class="detail-fact"><strong>${p.raw.apps}</strong> appearances</div>
          <div class="detail-fact"><strong>${p.raw.mins}</strong> mins</div>
          ${p.nat?`<div class="detail-fact"><strong>${p.nat}</strong></div>`:''}
        </div>
      </div>
      <div class="detail-score-wrap">
        <div class="detail-score" style="color:${sColor(p.score)}">${p.score}</div>
        <div class="detail-score-label">Overall Score</div>
      </div>
    </div>

    <div class="charts-row">
      <div class="card-panel">
        <div class="panel-title">Pizza Chart â€” Percentile Ranks</div>
        <div style="display:flex;justify-content:center">
          <canvas id="cv-pizza" width="300" height="300"></canvas>
        </div>
        <div class="pct-key">
          <div class="pct-key-item"><div class="pct-dot" style="background:#FFD700"></div>Gold â€” Top 10%</div>
          <div class="pct-key-item"><div class="pct-dot" style="background:#22c55e"></div>Green â€” Above avg</div>
          <div class="pct-key-item"><div class="pct-dot" style="background:#ca8a04"></div>Yellow â€” Average</div>
          <div class="pct-key-item"><div class="pct-dot" style="background:#e8192c"></div>Red â€” Below avg</div>
        </div>
      </div>
      <div class="card-panel">
        <div class="panel-title">Radar Chart â€” Attribute Profile</div>
        <div style="display:flex;justify-content:center">
          <canvas id="cv-radar" width="300" height="300"></canvas>
        </div>
      </div>
    </div>

    <div class="card-panel" style="margin-bottom:16px">
      <div class="panel-title">Raw Statistics (per game)</div>
      <div class="stats-boxes">
        ${statBoxes.map(([l,v])=>`<div class="stat-box"><div class="stat-box-val">${v}</div><div class="stat-box-lbl">${l}</div></div>`).join('')}
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end">
      <button class="btn btn-red" style="display:flex;align-items:center;gap:8px" onclick="openShareModal(${p.id})">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="white"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.737-8.856L1.561 2.25H8.37l4.261 5.636L18.244 2.25z"/></svg>
        Share to X
      </button>
    </div>
  `;

  requestAnimationFrame(() => { drawPizza('cv-pizza',p,150,150,118,36); drawRadar('cv-radar',p,150,150,110); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARE CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _sharePlayer = null;

function openShareModal(playerId) {
  const p = findP(playerId);
  if (!p) return;
  _sharePlayer = p;
  document.getElementById('shareModal').style.display = 'flex';
  requestAnimationFrame(() => renderShareCard(p));
}

function closeShareModal(e) {
  if (e && e.target !== document.getElementById('shareModal')) return;
  document.getElementById('shareModal').style.display = 'none';
}

function renderShareCard(p) {
  const cv = document.getElementById('shareCanvas');
  const ctx = cv.getContext('2d');
  const W = 600, H = 600;
  cv.width = W; cv.height = H;

  // â”€â”€ Background â”€â”€
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, W, H);

  // Diagonal stripes
  ctx.save();
  ctx.globalAlpha = 0.03;
  for (let i = -H; i < W + H; i += 28) {
    ctx.beginPath();
    ctx.moveTo(i, 0); ctx.lineTo(i + H, H);
    ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 10; ctx.stroke();
  }
  ctx.restore();

  // Red top bar
  ctx.fillStyle = '#e8192c';
  ctx.fillRect(0, 0, W, 5);

  // Red glow top-right
  const grd = ctx.createRadialGradient(W, 0, 0, W, 0, 280);
  grd.addColorStop(0, 'rgba(232,25,44,0.12)');
  grd.addColorStop(1, 'transparent');
  ctx.fillStyle = grd;
  ctx.fillRect(0, 0, W, H);

  // â”€â”€ Header: VITALYTICS brand â”€â”€
  ctx.fillStyle = '#e8192c';
  ctx.font = 'bold 15px Oswald, Arial, sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('VITALYTICS', 28, 38);

  ctx.fillStyle = '#444';
  ctx.font = '12px Barlow Condensed, Arial, sans-serif';
  ctx.fillText('by @_vitaminT__ Â· Scottish Football Analytics', 28, 54);

  // X logo top right
  ctx.fillStyle = '#333';
  ctx.font = 'bold 18px Arial';
  ctx.textAlign = 'right';
  ctx.fillText('ğ•', W - 24, 42);

  // â”€â”€ Divider â”€â”€
  ctx.fillStyle = '#1e1e1e';
  ctx.fillRect(24, 62, W - 48, 1);

  // â”€â”€ Player name block â”€â”€
  // Avatar circle
  ctx.beginPath();
  ctx.arc(64, 108, 30, 0, Math.PI * 2);
  const avatarGrd = ctx.createLinearGradient(34, 78, 94, 138);
  avatarGrd.addColorStop(0, '#e8192c');
  avatarGrd.addColorStop(1, '#7f0d18');
  ctx.fillStyle = avatarGrd;
  ctx.fill();

  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 18px Oswald, Arial, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(initials(p.name), 64, 108);
  ctx.textBaseline = 'alphabetic';

  // Name
  ctx.fillStyle = '#f0f0f0';
  ctx.font = `bold 26px Oswald, Arial, sans-serif`;
  ctx.textAlign = 'left';
  // Truncate long names
  let displayName = p.name.toUpperCase();
  if (ctx.measureText(displayName).width > 320) displayName = displayName.slice(0, 22) + 'â€¦';
  ctx.fillText(displayName, 106, 102);

  // Sub info
  ctx.fillStyle = '#666';
  ctx.font = '13px Barlow Condensed, Arial, sans-serif';
  ctx.fillText(`${posLabel(p.pos)}  Â·  ${p.teamName}  Â·  ${p.raw.apps} apps`, 106, 122);

  // Score badge
  const scoreX = W - 50, scoreY = 84;
  ctx.beginPath();
  ctx.roundRect(scoreX - 36, scoreY - 28, 72, 52, 6);
  ctx.fillStyle = '#161616';
  ctx.fill();
  ctx.strokeStyle = '#2e2e2e';
  ctx.lineWidth = 1;
  ctx.stroke();

  ctx.fillStyle = sColor(p.score);
  ctx.font = `bold 28px Oswald, Arial, sans-serif`;
  ctx.textAlign = 'center';
  ctx.fillText(p.score, scoreX, scoreY + 6);
  ctx.fillStyle = '#555';
  ctx.font = '10px Barlow Condensed, Arial, sans-serif';
  ctx.fillText('SCORE', scoreX, scoreY + 20);

  // â”€â”€ Divider â”€â”€
  ctx.fillStyle = '#1e1e1e';
  ctx.fillRect(24, 144, W - 48, 1);

  // â”€â”€ Pizza chart (left column) â”€â”€
  const pizzaCx = 175, pizzaCy = 340, pizzaR = 138, pizzaInner = 42;
  drawPizzaOnCtx(ctx, p, pizzaCx, pizzaCy, pizzaR, pizzaInner);

  // â”€â”€ Stats column (right) â”€â”€
  const statX = 360, statStartY = 170;
  ctx.fillStyle = '#e8192c';
  ctx.font = 'bold 11px Barlow Condensed, Arial, sans-serif';
  ctx.textAlign = 'left';
  ctx.letterSpacing = '2px';
  ctx.fillText('// PERCENTILE RANKS', statX, statStartY);

  const entries = Object.entries(p.pcts);
  const barW = 200, barH = 5;

  entries.forEach(([label, val], i) => {
    const y = statStartY + 22 + i * 40;
    const color = pColor(val);

    // Label
    ctx.fillStyle = '#888';
    ctx.font = '12px Barlow Condensed, Arial, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(label.toUpperCase(), statX, y);

    // Bar background
    ctx.fillStyle = '#1e1e1e';
    roundRectFill(ctx, statX, y + 6, barW, barH, 2);

    // Bar fill
    const h2r = hex => { const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return {r,g,b}; };
    const {r,g,b} = h2r(color);
    ctx.fillStyle = `rgba(${r},${g},${b},0.85)`;
    roundRectFill(ctx, statX, y + 6, Math.max(4, barW * val / 100), barH, 2);

    // Value
    ctx.fillStyle = val >= 60 ? color : '#666';
    ctx.font = `bold 14px Oswald, Arial, sans-serif`;
    ctx.textAlign = 'right';
    ctx.fillText(val, statX + barW + 28, y + 12);
  });

  // â”€â”€ Bottom watermark â”€â”€
  ctx.fillStyle = '#1e1e1e';
  ctx.fillRect(0, H - 40, W, 40);

  ctx.fillStyle = '#333';
  ctx.font = '11px Barlow Condensed, Arial, sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('vitalytics.app  Â·  ğŸ¥‡ Top 10%  ğŸŸ¢ Above avg  ğŸŸ¡ Average  ğŸ”´ Below avg', 24, H - 14);

  ctx.fillStyle = '#e8192c';
  ctx.font = 'bold 11px Oswald, Arial, sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText('@_vitaminT__', W - 24, H - 14);

  // â”€â”€ Set up X share link â”€â”€
  const topStats = entries.slice(0, 3).map(([l, v]) => `${l}: ${v}th pct`).join(' | ');
  const tweet = `${p.name} (${p.teamName}) â€” ${posLabel(p.pos)} Â· Score: ${p.score}/100\n${topStats}\n\nvia @_vitaminT__ Vitalytics ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿`;
  document.getElementById('xShareBtn').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweet)}`;
}

// Helper: rounded rect fill without Path2D for broad compat
function roundRectFill(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  ctx.fill();
}

// Draw pizza directly onto a given ctx (for share card)
function drawPizzaOnCtx(ctx, p, cx, cy, outerR, innerR) {
  const entries = Object.entries(p.pcts);
  const n = entries.length;
  const sa = -Math.PI / 2, slice = Math.PI * 2 / n;

  // Rings
  [25, 50, 75, 100].forEach(pct => {
    const r = innerR + (outerR - innerR) * pct / 100;
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(40,40,40,0.9)'; ctx.lineWidth = 1; ctx.stroke();
  });

  // Spokes
  entries.forEach((_, i) => {
    const a = sa + i * slice;
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(a) * innerR, cy + Math.sin(a) * innerR);
    ctx.lineTo(cx + Math.cos(a) * outerR, cy + Math.sin(a) * outerR);
    ctx.strokeStyle = 'rgba(30,30,30,0.8)'; ctx.lineWidth = 1; ctx.stroke();
  });

  const h2r = hex => { const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return{r,g,b}; };

  entries.forEach(([label, val], i) => {
    const a1 = sa + i * slice, a2 = a1 + slice;
    const fR = innerR + (outerR - innerR) * val / 100;
    const col = pColor(val);
    const {r, g, b} = h2r(col);

    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(a1) * innerR, cy + Math.sin(a1) * innerR);
    ctx.arc(cx, cy, fR, a1, a2);
    ctx.lineTo(cx + Math.cos(a2) * innerR, cy + Math.sin(a2) * innerR);
    ctx.arc(cx, cy, innerR, a2, a1, true);
    ctx.closePath();
    ctx.fillStyle = `rgba(${r},${g},${b},0.55)`; ctx.fill();
    ctx.strokeStyle = col; ctx.lineWidth = 1.5; ctx.stroke();

    // Labels
    const mid = a1 + slice / 2, lR = outerR + 20;
    const lx = cx + Math.cos(mid) * lR, ly = cy + Math.sin(mid) * lR;
    ctx.fillStyle = '#555'; ctx.font = '10px Barlow Condensed, Arial, sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(label, lx, ly - 7);
    ctx.fillStyle = val >= 60 ? col : '#555';
    ctx.font = 'bold 11px Oswald, Arial, sans-serif';
    ctx.fillText(val, lx, ly + 7);
  });

  // Centre hole
  ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI * 2);
  ctx.fillStyle = '#0a0a0a'; ctx.fill();

  // Centre score
  ctx.fillStyle = sColor(p.score);
  ctx.font = `bold 22px Oswald, Arial, sans-serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(p.score, cx, cy - 5);
  ctx.fillStyle = '#555'; ctx.font = '10px Barlow Condensed, Arial, sans-serif';
  ctx.fillText('SCORE', cx, cy + 10);
  ctx.textBaseline = 'alphabetic';
}

function downloadShare() {
  const cv = document.getElementById('shareCanvas');
  const a = document.createElement('a');
  a.download = `vitalytics-${(_sharePlayer?.name||'player').replace(/\s+/g,'-').toLowerCase()}.png`;
  a.href = cv.toDataURL('image/png');
  a.click();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PIZZA CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawPizza(id, p, cx, cy, outerR, innerR) {
  const cv = document.getElementById(id); if(!cv) return;
  const ctx = cv.getContext('2d');
  const entries = Object.entries(p.pcts);
  const n = entries.length;
  const sa = -Math.PI/2, slice = Math.PI*2/n;
  ctx.clearRect(0,0,cv.width,cv.height);

  // Rings
  [25,50,75,100].forEach(pct=>{
    const r = innerR+(outerR-innerR)*pct/100;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.strokeStyle='rgba(46,46,46,0.9)'; ctx.lineWidth=1; ctx.stroke();
  });

  // Spokes
  entries.forEach((_,i)=>{
    const a=sa+i*slice;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(a)*innerR, cy+Math.sin(a)*innerR);
    ctx.lineTo(cx+Math.cos(a)*outerR, cy+Math.sin(a)*outerR);
    ctx.strokeStyle='rgba(36,36,36,0.8)'; ctx.lineWidth=1; ctx.stroke();
  });

  // Slices
  const h2r = hex=>{const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return{r,g,b};};
  entries.forEach(([l,v],i)=>{
    const a1=sa+i*slice, a2=a1+slice;
    const fR = innerR+(outerR-innerR)*v/100;
    const col = pColor(v);
    const {r,g,b} = h2r(col);
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(a1)*innerR, cy+Math.sin(a1)*innerR);
    ctx.arc(cx,cy,fR,a1,a2);
    ctx.lineTo(cx+Math.cos(a2)*innerR, cy+Math.sin(a2)*innerR);
    ctx.arc(cx,cy,innerR,a2,a1,true);
    ctx.closePath();
    ctx.fillStyle=`rgba(${r},${g},${b},0.5)`; ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=1.5; ctx.stroke();

    // Labels
    const mid=a1+slice/2, lR=outerR+18;
    const lx=cx+Math.cos(mid)*lR, ly=cy+Math.sin(mid)*lR;
    ctx.fillStyle='#555'; ctx.font=`10px Barlow Condensed,sans-serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(l,lx,ly-6);
    ctx.fillStyle=v>=60?col:'#555'; ctx.font=`bold 11px Barlow Condensed,sans-serif`;
    ctx.fillText(v,lx,ly+6);
  });

  // Centre
  ctx.beginPath(); ctx.arc(cx,cy,innerR,0,Math.PI*2);
  ctx.fillStyle='#111111'; ctx.fill();
  ctx.fillStyle=sColor(p.score); ctx.font=`bold 19px Oswald,sans-serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(p.score,cx,cy-4);
  ctx.fillStyle='#555'; ctx.font=`9px Barlow,sans-serif`;
  ctx.fillText('SCORE',cx,cy+8);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RADAR CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawRadar(id, p, cx, cy, r) {
  const cv = document.getElementById(id); if(!cv) return;
  const ctx = cv.getContext('2d');
  const entries = Object.entries(p.pcts);
  const n = entries.length, sa=-Math.PI/2, sl=Math.PI*2/n;
  ctx.clearRect(0,0,cv.width,cv.height);

  [.2,.4,.6,.8,1].forEach(f=>{
    ctx.beginPath();
    entries.forEach((_,i)=>{
      const a=sa+i*sl, x=cx+Math.cos(a)*r*f, y=cy+Math.sin(a)*r*f;
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.closePath();
    ctx.strokeStyle='rgba(36,36,36,0.9)'; ctx.lineWidth=1; ctx.stroke();
  });

  entries.forEach((_,i)=>{
    const a=sa+i*sl;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(a)*r, cy+Math.sin(a)*r);
    ctx.strokeStyle='rgba(36,36,36,0.7)'; ctx.lineWidth=1; ctx.stroke();
  });

  ctx.beginPath();
  entries.forEach(([,v],i)=>{
    const a=sa+i*sl, pr=r*v/100;
    i===0?ctx.moveTo(cx+Math.cos(a)*pr,cy+Math.sin(a)*pr):ctx.lineTo(cx+Math.cos(a)*pr,cy+Math.sin(a)*pr);
  });
  ctx.closePath();
  ctx.fillStyle='rgba(232,25,44,0.1)'; ctx.fill();
  ctx.strokeStyle='#e8192c'; ctx.lineWidth=2; ctx.stroke();

  entries.forEach(([,v],i)=>{
    const a=sa+i*sl, pr=r*v/100;
    ctx.beginPath(); ctx.arc(cx+Math.cos(a)*pr, cy+Math.sin(a)*pr, 3,0,Math.PI*2);
    ctx.fillStyle='#e8192c'; ctx.fill();
  });

  entries.forEach(([l],i)=>{
    const a=sa+i*sl;
    ctx.fillStyle='#555'; ctx.font='10px Barlow Condensed,sans-serif';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(l, cx+Math.cos(a)*(r+16), cy+Math.sin(a)*(r+16));
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RANKINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function populateRankLeagueSelect() {
  const sel = document.getElementById('rkLeague');
  const loaded = Object.keys(S.byLeague).filter(id => S.byLeague[id]?.length);
  if (!loaded.length) { sel.innerHTML='<option value="">â€” Load a league first â€”</option>'; return; }
  const current = sel.value;
  sel.innerHTML = loaded.map(id => {
    let name = `League ${id}`;
    for (const leagues of Object.values(LEAGUES_BY_COUNTRY)) {
      const found = leagues.find(l => l.id === parseInt(id));
      if (found) { name = found.name; break; }
    }
    return `<option value="${id}" ${parseInt(id)===parseInt(current)?'selected':''}>${name}</option>`;
  }).join('');
  if (!sel.value && loaded.length) sel.value = loaded[0];
}

function buildRankings() {
  populateRankLeagueSelect();
  const tid = parseInt(document.getElementById('rkLeague').value);
  const pos = document.getElementById('rkPos').value;
  const el = document.getElementById('rankArea');
  let ps = S.byLeague[tid] || [];
  if (!ps.length) { el.innerHTML='<div class="empty-state"><h3>No data</h3><p>Load this league from the Search tab first</p></div>'; return; }
  if (pos!=='ALL') ps=ps.filter(p=>p.pos===pos);
  const sorted=[...ps].sort((a,b)=>b.score-a.score);
  const rc=i=>i===0?'g1':i===1?'g2':i===2?'g3':'';
  el.innerHTML=`
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden">
      <table class="rank-table">
        <thead><tr>
          <th style="width:48px">#</th><th>Player</th><th>Pos</th><th>Club</th><th>Apps</th><th>Score</th>
        </tr></thead>
        <tbody>${sorted.slice(0,100).map((p,i)=>`
          <tr onclick="openDetailFromRank(${p.id})">
            <td><div class="rank-num ${rc(i)}">${i+1}</div></td>
            <td><div class="rank-pname">${p.name}</div></td>
            <td><span class="tag tag-pos">${posLabel(p.pos)}</span></td>
            <td style="color:var(--muted2);font-size:13px">${p.teamShort}</td>
            <td style="color:var(--muted);font-size:13px">${p.raw.apps}</td>
            <td>
              <div class="rank-bar-row">
                <div class="rank-bar-bg"><div class="rank-bar-inner" style="width:${p.score}%"></div></div>
                <div class="rank-val">${p.score}</div>
              </div>
            </td>
          </tr>
        `).join('')}</tbody>
      </table>
    </div>
  `;
}
function openDetailFromRank(id) {
  S.prevPage='rankings';
  const p=findP(id); if(!p) return;
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-detail').classList.add('active');
  renderDetail(p);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPARE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleCmp(id, e) {
  e.stopPropagation();
  const idx=S.cmpQueue.indexOf(id);
  if(idx>-1) S.cmpQueue.splice(idx,1);
  else { if(S.cmpQueue.length>=2) S.cmpQueue.shift(); S.cmpQueue.push(id); }
  updateFloatBar(); renderGrid();
}
function updateFloatBar() {
  const bar=document.getElementById('floatBar');
  if(!S.cmpQueue.length){bar.style.display='none';return;}
  bar.style.display='flex';
  document.getElementById('floatNames').textContent=S.cmpQueue.map(id=>{const p=findP(id);return p?p.name.split(' ').pop():'?';}).join(' vs ');
}
function clearCmp() { S.cmpQueue=[]; updateFloatBar(); renderGrid(); }
function goCompare() {
  if(S.cmpQueue.length<2) return;
  showPage('compare');
  const pa=findP(S.cmpQueue[0]), pb=findP(S.cmpQueue[1]);
  if(!pa||!pb) return;
  renderCompare(pa,pb);
}

function renderCompare(pa,pb) {
  const el=document.getElementById('compareArea');
  const keys=[...new Set([...Object.keys(pa.pcts),...Object.keys(pb.pcts)])];
  el.innerHTML=`
    <div class="compare-banner">
      <div class="compare-col">
        <div class="compare-name">${pa.name}</div>
        <div class="compare-sub">${posLabel(pa.pos)} Â· ${pa.teamName}</div>
        <div class="compare-big" style="color:${sColor(pa.score)}">${pa.score}</div>
      </div>
      <div class="compare-mid"><div class="vs-txt">VS</div></div>
      <div class="compare-col" style="text-align:right">
        <div class="compare-name">${pb.name}</div>
        <div class="compare-sub">${posLabel(pb.pos)} Â· ${pb.teamName}</div>
        <div class="compare-big" style="color:${sColor(pb.score)}">${pb.score}</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
      <div class="card-panel">
        <div class="panel-title">${pa.name.split(' ').pop()}</div>
        <div style="display:flex;justify-content:center"><canvas id="cmp-pz1" width="260" height="260"></canvas></div>
      </div>
      <div class="card-panel">
        <div class="panel-title">${pb.name.split(' ').pop()}</div>
        <div style="display:flex;justify-content:center"><canvas id="cmp-pz2" width="260" height="260"></canvas></div>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden">
      <table class="compare-table">
        <thead><tr>
          <th style="text-align:right;padding:11px 16px;color:var(--red);font-family:'Barlow Condensed',sans-serif;font-size:12px;letter-spacing:1px;width:40%">${pa.name}</th>
          <th style="text-align:center;color:var(--muted);font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:1px;width:20%">STAT</th>
          <th style="text-align:left;padding:11px 16px;color:var(--muted2);font-family:'Barlow Condensed',sans-serif;font-size:12px;letter-spacing:1px;width:40%">${pb.name}</th>
        </tr></thead>
        <tbody>${keys.map(k=>{
          const va=pa.pcts[k]??0, vb=pb.pcts[k]??0;
          const aw=va>vb, bw=vb>va;
          return `<tr>
            <td class="c-val left ${aw?'win':bw?'lose':''}">${va}</td>
            <td class="c-name-cell">${k}</td>
            <td class="c-val right ${bw?'win':aw?'lose':''}">${vb}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>
    </div>
  `;
  requestAnimationFrame(()=>{
    drawPizza('cmp-pz1',pa,130,130,100,30);
    drawPizza('cmp-pz2',pb,130,130,100,30);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLoading(id, main, sub) {
  document.getElementById(id).innerHTML=`
    <div class="loading-wrap">
      <div class="spinner"></div>
      <div class="loading-main">${main}</div>
      <div class="loading-sub">${sub}</div>
    </div>`;
}

// Boot
setStatus('','Select a country and league to begin');
initPicker();
</script>

</body>
</html>
